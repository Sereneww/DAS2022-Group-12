---
title: "groupwork"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,eval=TRUE}
library(ggplot2)
library(dplyr)
library(ggcorrplot)
library(tseries)
library(RColorBrewer)
library(ggstatsplot)
library(car)
library(GGally)
library(knitr)
library(moderndive)
library(gapminder)
library(skimr)
library(kableExtra)
library(gridExtra)
```


## summary

In order to investigate which factors are associated with the number of deaths due to disease, we selected three different indicators (pm2.5, daily calorie intake per capita, gdp per capita) from 141 countries and regions in three different directions (air quality, nutrition level, economic level) and used a multiple linear regression model to first test the correlation coefficients on the cross-sectional data, pass and then build a stepwise regression model. Irrelevant variables were excluded, followed by significance tests, normality tests, homoscedasticity tests and independence tests on the equation coefficients. All basic tests were passed at a significance level of 0.05, after which the model was regressed and the effect of pm2.5 and daily calorie intake on the number of deaths was found to be more significant.


```{r load and set,eval=TRUE}
dataw<-read.csv("/Users/serene/Desktop/gpwork.csv")
y <- dataw$total.deaths
x1 <- dataw$pm2.5
x2 <- dataw$Caloric.supply.
x3 <- dataw$GDP.
mydata <- data.frame(y,x1,x2,x3)
```

## Data presentation and description
The data was sourced from 141 countries and territories on our world indata in 2017. 
A total of three indicators were selected for the independent variables, with environmental factors measured by PM2.5 air pollution, mean annual exposure (micrograms per cubic meter).Nutritional levels are measured by Daily caloric supply (OWID based on UN FAO & historical sources).The economic indicators are GDP per capita.They are included in the initial model as x1,x2,x3 respectively.
The dependent variable is the total number of deaths due to disease, which is included in the model as y.

## from branch 1

Before starting the analysis, we need to have a general idea of how the data relate to each other. 

```{r code1.1}
ggpairs(mydata,columns = 2:4,
        lower = list(continuous="points"),
        diag = list(continuous="densityDiag"),
        upper = list(continuous="cor"))+
  scale_color_manual(values=c("red","blue","green"))+
  scale_fill_manual(values = c("orange","yellow","purple"))+
  theme_bw()
```

```{r code1.2}
corr <- round(cor(dataw[,2:5]),1)
ggcorrplot(corr, hc.order = TRUE, 
           type = "lower", 
           lab = TRUE, 
           lab_size = 5, 
           colors = c("#6D9EC1", "white", "#E46726"), 
           title="Correlogram of data", 
           ggtheme=ggplot2::theme_gray)

```

By testing the correlation between the independent variables, we found a significant linear relationship between gdp and calories per capita per day, with the remaining variables correlating to a lesser extent, and further testing is required for the specific analysis.

##Stepwise regression analysis

```{r model1}
fitmodel <- lm(y~x1+x2+x3,data=mydata)
summary(fitmodel)
kappa(fitmodel)
```

The first model fit, but did not pass the multicollinearity test, considered to be due to the strong correlation between the variables. Therefore stepwise regression was adopted for variable screening.

```{r model2}
step(fitmodel,direction = "both")
fitmodel2 <- lm(y ~ x1 + x2,data=mydata)
summary(fitmodel2)
kappa(fitmodel2)
```

The stepwise regression only incorporates x1,x2, and these two were selected to build modle2,However, the problem of multicollinearity was still found to exist, so a logarithmic transformation of the model was considered.

```{r final model & table}
fitmodel3 <- lm(log(y) ~ log(x1) + log(x2),data=mydata)
summary(fitmodel3)
kappa(fitmodel3) 

get_regression_table(fitmodel3)%>%
  kable(caption = '\\label{tab:reg} Estimates of the intercept and slope from the fitted linear regression model.',format = "latex")

```

The results illustrate that the p-values of the log-transformed x1 and x2 and the unstandardised regression coefficients of the constants are all less than 0.05 and pass the t-test. When each 0.963% increase in the air pollution index is associated with a 1% increase in deaths and a 2.527% increase in daily calorie consumption per capita is associated with a 1% increase in deaths, the model shows that gdp per capita is not a significant variable and the combination of the correlation plots shows that the reason for the insignificance comes from the covariance between gdp and daily calories.


##Testing the model with residual analysis

```{r Normality test, homoscedasticity test, independence test}
shapiro.test(rstandard(fitmodel3)) 
ncvTest(fitmodel3)
durbinWatsonTest(fitmodel3)
```
All mean values are greater than 0.05 and pass the test.

```{r residual plot}
par(mfrow=c(2,2))
plot(fitmodel3)
```

The scatter plots showed that the residuals were approximately evenly distributed above and below the zero line, so the assumption that the residuals had a mean of zero appeared to be valid. The histogram supports the assumption of normally distributed errors in the model.

## Conclusion and the future

This analysis tried to explore the factors affecting the number of deaths by selecting three different aspects of indicators, and the results showed that air quality and nutrition level had a more significant effect on the number of deaths. At the same time, we find that there is a closer association between gdp and per capita nutritional intake, and later improvements to the model could try to replace gdp factors in other areas.
We note that the coefficients of the regression model are not very high, which proves that the predictive power of the model is weak. Considering that this is due to the problem that the causes of death from disease are influenced by many other factors, the next work will also consider adding variables to improve the predictive power of the model.

